<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Date Range Analysis</title>
  <link rel="stylesheet" href="./lib/jquery-ui.css">
  <script src="./lib/jquery-2.1.1.min.js"></script>
  <script src="./lib/jquery-ui.js"></script>

  <script>
  const REMOTE = "http://192.168.0.29:3999";
  const LOCAL = "http://localhost:3999";
  var HOST = LOCAL;

  var codeList =[];
  var base = "";

  function populateDropDown()
  {
      $.ajax({url:HOST+"/currency/list",type:"GET",success:processCurrencyList});
      $('#endpoint').html("<b>Endpoint: "+HOST+"</b>");
  }

  function processCurrencyList(data,type,jqXHR)
  {
      currencyList = data;
      for(var key in data)
      {
          codeList.push(key);
          $("<option value=\""+key+"\">"+key+" "+data[key]+"</option>").appendTo("#base_currency");
          $("#chart_div_"+key).remove();
        }
  }

  $(function() {
    $( "#startDate" ).datepicker();
    $( "#endDate" ).datepicker();
  });

  function process()
  {
    var startDate = hGetDate("startDate");
    var endDate = hGetDate("endDate");
    if(startDate>=endDate)
    {
      alert("Error: Start date must be less than End date.");
    }
    else
    {
      base = $(base_currency).val();
      $.ajax({url:HOST+"/currency/sequence/range/date/"+startDate+"/"+endDate+"/"+base,type:"GET",success:processRange});
    }

  }

  function processRange(data,type,jqXHR)
  {
   var stats = {};
   var json = JSON.parse(data);
   var metaData = {};
   metaData.header = json[0];
   metaData.footer = json[json.length-1];

   for(var i=1;i<json.length-1;i++)
   {
     var currList = json[i];

     for(var key in currList)
     {
       if(key == "_id")
       {
        if(i==1)
        {
          stats[startDate] = new Date(currList[key]);
        }
        else if(i==json.length-1)
        {
          stats[endDate] = new Date(currList[key]);
        }
       }
       else
       {
         var changed = false;

         if(stats[key] == null)
         {
           stats[key] = {};
         }
         if(stats[key].max==null || stats[key].max < currList[key])
         {
           stats[key].max = currList[key];
           changed = true;
         }

         if(stats[key].min==null || stats[key].min > currList[key])
         {
           stats[key].min = currList[key];
           changed = true;
         }

         if(changed)
         {
           stats[key].pchange = (stats[key].max - stats[key].min)*100/stats[key].min;
           stats[key].range = (stats[key].max - stats[key].min);
         }
       }
     }
   }
   var htmlOut = "<b> Start Date: </b>"+stats[startDate]+ "   <b> End Date: </b>"+stats[endDate]+"</br>";
   $("#dataOut").html(htmlOut);
  }

  function hGetDate(id)
  {
    var date = $("#"+id ).datepicker("getDate").getTime();
    return date!=null ? date*1 : 0*1;
  }
  </script>
</head>
<body style="font-family:verdana" onload="populateDropDown()">
  <span id="endpoint" style="font-family:verdana;font-size:small"></span></span><span style="padding-left:15px;font-family:verdana;font-size:small">Base Currency:</span><select id="base_currency"></select>
<span style="margin-left:5px">Start Date: <input type="text" id="startDate"></input></span>
<span style="margin-left:5px">End Date: <input type="text" id="endDate"></input></span>
<span style="margin-left:5px"><input type="button" onclick="process()" value="Process" id="process"></input></span>
<div id="dataOut"></div>

</body>
</html>
